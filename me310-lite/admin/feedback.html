<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feedback Admin</title>
  <link rel="stylesheet" href="../styles.css" />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabaseClient.js"></script>
  <style>
    .panel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .tbl{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .tbl th,.tbl td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    .tbl th{background:#f9fafb;text-align:left;color:#374151}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;margin-right:6px}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .muted{color:#6b7280}
    .success{padding:10px;border:1px solid #d1fae5;background:#ecfdf5;border-radius:10px;color:#065f46}
    .error{padding:10px;border:1px solid #fee2e2;background:#fef2f2;border-radius:10px;color:#7f1d1d}
    .authBox{max-width:500px;margin:0 auto}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1>Feedback Admin</h1>
      <p class="subtitle">Sign in, then review, filter, mark resolved, and export.</p>
    </div>
  </header>

  <main class="container">
    <nav class="back-row">
      <a href="../index.html" class="back-home" aria-label="Back to home">← Home</a>
    </nav>

    <!-- Auth gate -->
    <section id="auth" class="panel authBox">
      <h3 style="margin:0 0 8px">Admin sign in</h3>
      <p class="muted" style="margin:0 0 10px">Enter your email to receive a magic link.</p>
      <div class="row">
        <input id="adminEmail" type="email" placeholder="aarav.r.shah@gmail.com" style="padding:10px;border:1px solid var(--line);border-radius:10px;flex:1;min-width:240px">
        <button id="sendLink" class="btn primary">Send magic link</button>
      </div>
      <div id="authMsg" style="margin-top:10px"></div>
    </section>

    <!-- Dashboard -->
    <section id="dash" class="panel" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <select id="fCourse">
            <option value="">Course: all</option>
            <option>ME 310</option>
            <option>ME 320</option>
            <option>ME 400</option>
            <option>Other</option>
          </select>
          <select id="fCategory">
            <option value="">Category: all</option>
            <option>Idea</option><option>UX</option><option>Content</option><option>Bug</option><option>Other</option>
          </select>
          <select id="fResolved">
            <option value="">Status: all</option>
            <option value="false" selected>Unresolved first</option>
            <option value="true">Resolved only</option>
          </select>
        </div>
        <div class="row">
          <button id="refresh" class="btn">Refresh</button>
          <button id="export" class="btn">Export CSV</button>
          <button id="signout" class="btn">Sign out</button>
        </div>
      </div>

      <div id="count" class="muted" style="margin:8px 0 12px"></div>

      <div style="overflow:auto">
        <table class="tbl" id="tbl">
          <thead>
            <tr>
              <th>When</th>
              <th>Course / Page</th>
              <th>Category / Rating</th>
              <th>Message</th>
              <th>Contact</th>
              <th>Meta</th>
              <th>Resolved</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div id="dashMsg" style="margin-top:10px"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container"><p>&copy; <span id="year"></span> UIUC • Teaching Tools</p></div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const authBox = document.getElementById('auth');
    const dash = document.getElementById('dash');
    const authMsg = document.getElementById('authMsg');
    const dashMsg = document.getElementById('dashMsg');
    const rows = document.getElementById('rows');

    const ADMIN_EMAIL = 'aarav.r.shah@gmail.com'; // matches RLS policy

    // Handle deep-link after magic link return
    window.sb.auth.onAuthStateChange((event, session)=>{
      if (session?.user) {
        // Optional: extra UI gate so only your email can see UI
        if (session.user.email !== ADMIN_EMAIL){
          authMsg.className = 'error';
          authMsg.textContent = 'Signed in, but not authorized for this dashboard.';
          window.sb.auth.signOut();
          return;
        }
        authBox.style.display = 'none';
        dash.style.display = 'block';
        loadData();
      }
    });

    // Send magic link
    document.getElementById('sendLink').addEventListener('click', async ()=>{
      authMsg.textContent = ''; authMsg.className = '';
      const email = document.getElementById('adminEmail').value.trim();
      if (!email) return;
      const { error } = await window.sb.auth.signInWithOtp({ email });
      if (error){ authMsg.className = 'error'; authMsg.textContent = 'Error sending link.'; return; }
      authMsg.className = 'success';
      authMsg.textContent = 'Check your email for the sign-in link.';
    });

    document.getElementById('signout').addEventListener('click', async ()=>{
      await window.sb.auth.signOut();
      location.reload();
    });

    // Filters + actions
    document.getElementById('refresh').addEventListener('click', loadData);
    document.getElementById('fCourse').addEventListener('change', loadData);
    document.getElementById('fCategory').addEventListener('change', loadData);
    document.getElementById('fResolved').addEventListener('change', loadData);

    async function loadData(){
      rows.innerHTML = '';
      dashMsg.textContent = '';
      const fc = document.getElementById('fCourse').value;
      const fcat = document.getElementById('fCategory').value;
      const fres = document.getElementById('fResolved').value;

      let q = window.sb.from('feedback').select('*').order('resolved', { ascending:true }).order('created_at', { ascending:false });

      if (fc)   q = q.eq('course', fc);
      if (fcat) q = q.eq('category', fcat);
      if (fres !== '') q = q.eq('resolved', fres === 'true');

      const { data, error } = await q;
      if (error){ dashMsg.className='error'; dashMsg.textContent='Load error.'; console.error(error); return; }

      document.getElementById('count').textContent = `${data.length} entr${data.length===1?'y':'ies'}`;

      for (const r of data){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div>${new Date(r.created_at).toLocaleString()}</div></td>
          <td>
            <div><span class="pill">${r.course||'—'}</span></div>
            <div class="muted">${r.page||'—'}</div>
          </td>
          <td>
            <div><span class="pill">${r.category||'—'}</span></div>
            <div class="muted">${r.rating ? ('Rating: '+r.rating) : '—'}</div>
          </td>
          <td style="min-width:280px;white-space:pre-wrap">${r.message||''}</td>
          <td>
            <div>${r.email||'—'}</div>
          </td>
          <td class="muted" style="min-width:220px">
            <div>${r.path||'/'}</div>
            <div style="max-width:320px;overflow:hidden;text-overflow:ellipsis">${r.user_agent||''}</div>
          </td>
          <td>
            <label class="row" style="gap:6px;align-items:center">
              <input type="checkbox" ${r.resolved?'checked':''} data-id="${r.id}" class="resolveBox"/>
              <span>${r.resolved?'Resolved':'Open'}</span>
            </label>
          </td>
        `;
        rows.appendChild(tr);
      }

      // wire up toggles
      document.querySelectorAll('.resolveBox').forEach(cb=>{
        cb.addEventListener('change', async (e)=>{
          const id = +e.target.dataset.id;
          const val = e.target.checked;
          const { error } = await window.sb.from('feedback').update({ resolved: val }).eq('id', id);
          if (error){ alert('Update failed'); console.error(error); }
        });
      });
    }

    // CSV export
    document.getElementById('export').addEventListener('click', async ()=>{
      let q = window.sb.from('feedback').select('*').order('created_at', { ascending:false });
      const { data, error } = await q;
      if (error){ alert('Export failed'); return; }
      const headers = ['id','created_at','course','page','category','rating','message','email','user_agent','path','resolved'];
      const rows = data.map(r => headers.map(h => (r[h] ?? '')).map(v => `"${String(v).replace(/"/g,'""')}"`).join(',') );
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `feedback_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    });

    // Kick off (if session already present after redirect)
    (async () => {
      const { data:{session} } = await window.sb.auth.getSession();
      if (session?.user && session.user.email === ADMIN_EMAIL){
        authBox.style.display = 'none';
        dash.style.display = 'block';
        loadData();
      }
    })();
  </script>
</body>
</html>
