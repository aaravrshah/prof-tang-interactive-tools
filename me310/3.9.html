<!-- /me310/3.9.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flow in a Variable-Area Pipe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- MathJax -->
  <script>
    window.MathJax = { chtml:{scale:0.92}, options:{renderActions:{addMenu:[]}} };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{ --Y_TITLE_PAD: 15px; --plot-min-h: 420px; }

    .ctl{background:#fff;border:1px solid var(--line);border-radius:var(--r-sm);padding:10px 12px}
    .eqwrap{padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fcfcff}

    /* ===== TOP: left content + right sticky schematic ===== */
    .top-grid{
      display:grid;
      gap:12px;
      align-items:start;
    }
    @media(min-width:980px){
      .top-grid{ grid-template-columns: 1.25fr 0.75fr; }
    }
    .stack{display:grid;gap:12px}

    .sticky-schem{
      position: sticky;
      top: 12px;
      align-self:start;
    }

    .schem-box{
      height: 520px;
      display:grid;
      place-items:center;
      border:2px dashed var(--line);
      border-radius:12px;
      background:#fafcff;
      color:#64748b;
      text-align:center;
      padding:12px;
    }
    .schem-box .t{font-weight:800;color:#334155;margin-bottom:6px}

    /* ===== BOTTOM: full width inputs + plot ===== */
    .io-grid{display:grid;gap:12px;align-items:stretch;margin-top:12px}
    @media(min-width:1024px){
      .io-grid{ grid-template-columns: 1fr 1.45fr; }
    }

    .inputs-grid{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    }
    .ctl>label{display:block;font-size:13px;color:#4b5563;margin-bottom:6px}
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pair input[type="number"]{
      width:100%;
      padding:6px 8px;
      border:1px solid var(--line);
      border-radius:8px;
      background:#fff;
    }
    .pair input[type="range"]{width:100%}

    .kpis{
      display:grid;
      gap:10px;
      margin-top:10px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    .kpi{
      background:#fcfcff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
    }
    .kpi .lab{font-size:12px;color:#6b7280}
    .kpi .val{font-size:16px;font-weight:700;color:#111;margin-top:2px}

    .plot-wrap{display:flex;flex-direction:column;height:100%}
    .viz{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px}
    .plot-wrap .viz{
      flex:1 1 auto;
      display:flex;
      padding:14px;
      border-radius:14px;
    }
    .plot-wrap .viz svg{
      width:100%;
      display:block;
      min-height:var(--plot-min-h);
    }

    .axis text{font-size:14px;fill:#111}
    .axis-title{font-size:16px;fill:#111}
    svg text{paint-order:stroke;stroke:#fff;stroke-width:3px;stroke-linejoin:round}
    .curve{stroke:#111;fill:none;stroke-width:2}
    .dragpt{fill:var(--danger);stroke:#111;stroke-width:1.2}
    .hit{fill:transparent;cursor:ew-resize}
    .zeroline{stroke:#000;stroke-opacity:.18;stroke-dasharray:6 6}
  </style>
</head>

<body>
<header class="site-header">
  <div class="container">
    <div class="header-row">
      <h1 style="margin:0">Flow in a Variable-Area Pipe</h1>
      <a class="btn primary feedback-link" href="../feedback.html" target="_blank" rel="noopener">Send feedback</a>
    </div>
  </div>
</header>

<main class="container">
  <nav class="back-row">
    <a href="../index.html" class="back-home" aria-label="Back to home"><span class="chev">←</span> Home</a>
  </nav>

  <!-- ===== TOP SECTION (sticky schematic stops here) ===== -->
  <section class="top-grid">

    <!-- LEFT: Problem + Analysis -->
    <div class="stack">
      <section class="card ps">
        <h3 style="margin:6px 0 10px">Problem Statement</h3>
        <div class="eqwrap">
          <h4 style="margin:0 0 6px">Known</h4>
          <ul style="margin:6px 0 10px 20px">
            <li>Water flows through a pipe reducer.</li>
            <li>The static pressures at positions (1) and (2) are measured by the inverted U-tube manometer containing oil of specific gravity, SG, less than one.</li>
          </ul>

          <h4 style="margin:0 0 6px">Find</h4>
          <p style="margin:0">Determine the volumetric flow rate \(Q\) for a manometer reading \(h\).</p>
        </div>
      </section>

      <section class="card analysis-card">
        <h3 style="margin:6px 0 8px">Analysis</h3>

        <div class="eqwrap" style="margin-top:8px">
          <p style="margin:0 0 6px"><b>To relate \(p_1\) and \(p_2\) through the manometer:</b></p>
          \[
            p_1-\gamma(z_2-z_1)-\gamma(h+\ell)+\mathrm{SG}\,\gamma\,h+\gamma\ell=p_2
          \]
          \[
            p_1-p_2=\gamma(z_2-z_1)+\gamma h(1-\mathrm{SG}) \qquad (1)
          \]
        </div>

        <div class="eqwrap" style="margin-top:10px">
          <p style="margin:0 0 6px"><b>Apply Bernoulli Equation along streamline from point 1 to point 2.</b></p>
          \[
            p_1+\gamma z_1+\frac12\rho V_1^2=p_2+\gamma z_2+\frac12\rho V_2^2
          \]
          \[
            p_1-p_2=\gamma(z_2-z_1)+\frac12\rho V_2^2\left[1-\left(\frac{V_1}{V_2}\right)^2\right]
          \]
        </div>

        <div class="eqwrap" style="margin-top:10px">
          <p style="margin:0 0 6px"><b>The conservation of mass gives:</b></p>
          \[
            \dot{m}_1=\dot{m}_2 \Rightarrow \rho Q_1=\rho Q_2 \Rightarrow Q_1=Q_2 \Rightarrow V_1A_1=V_2A_2
          \]
          \[
            V_1\frac{\pi}{4}D_1^2=V_2\frac{\pi}{4}D_2^2
          \]
          \[
            \frac{V_1}{V_2}=\left(\frac{D_2}{D_1}\right)^2
          \]
          \[
            p_1-p_2=\gamma(z_2-z_1)+\frac12\rho V_2^2\left[1-\left(\frac{D_2}{D_1}\right)^4\right] \qquad (2)
          \]
        </div>

        <div class="eqwrap" style="margin-top:10px">
          <p style="margin:0 0 6px"><b>The comparison between eq (1) and eq (2) gives</b></p>
          \[
            \gamma h(1-\mathrm{SG})=\frac12\rho V_2^2\left[1-\left(\frac{D_2}{D_1}\right)^4\right]
          \]
          \[
            V_2=\frac{Q}{A_2}=\frac{Q}{\frac{\pi}{4}D_2^2}=\frac{4Q}{\pi D_2^2}
          \]
          \[
            Q=\left(\frac{\pi^2D_2^4gh(1-\mathrm{SG})}{8\left[1-\left(\frac{D_2}{D_1}\right)^4\right]}\right)^{1/2}
          \]
          <p style="margin:10px 0 0"><b>Comment:</b> The term \(z_2-z_1\) is not involved in the relationship between \(Q\) and \(h\).</p>
        </div>
      </section>
    </div>

    <!-- RIGHT: Sticky schematic (stops before bottom section because it's outside that section) -->
    <aside class="sticky-schem" aria-label="Schematic">
      <div class="card">
        <h3 style="margin:6px 0 10px">Schematic</h3>
        <div class="schem-box">
          <div>
            <div class="t">Schematic placeholder</div>
            <div>Reducer with taps \(p_1\), \(p_2\), inverted U-tube manometer (oil, SG &lt; 1), reading \(h\).</div>
          </div>
        </div>
      </div>
    </aside>

  </section>

  <!-- ===== BOTTOM SECTION (full width; no schematic column) ===== -->
  <section class="io-grid" id="io">

    <section class="card">
      <h3 style="margin:6px 0 10px">Inputs &amp; Outputs</h3>

      <div class="inputs-grid">
        <div class="ctl">
          <label>Upstream diameter, \(D_1\) (mm)</label>
          <div class="pair">
            <input id="D1" type="number" step="1" value="75">
            <input id="D1_s" type="range" step="1">
          </div>
        </div>

        <div class="ctl">
          <label>Downstream diameter, \(D_2\) (mm)</label>
          <div class="pair">
            <input id="D2" type="number" step="1" value="35">
            <input id="D2_s" type="range" step="1">
          </div>
        </div>

        <div class="ctl">
          <label>Oil specific gravity, SG</label>
          <div class="pair">
            <input id="SG" type="number" step="0.01" value="0.80">
            <input id="SG_s" type="range" step="0.01">
          </div>
        </div>

        <div class="ctl" style="grid-column:1 / -1">
          <label>Manometer reading, \(h\) (mm)</label>
          <div class="pair" style="grid-template-columns:260px 1fr">
            <input id="h" type="number" step="1" value="40">
            <input id="h_s" type="range" step="1">
          </div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="lab">Flow rate, \(Q\)</div>
          <div class="val" id="Q_ml">—</div>
        </div>
        <div class="kpi">
          <div class="lab">Downstream speed, \(V_2\)</div>
          <div class="val" id="V2">—</div>
        </div>
        <div class="kpi">
          <div class="lab">Upstream speed, \(V_1\)</div>
          <div class="val" id="V1">—</div>
        </div>
      </div>
    </section>

    <section class="card plot-wrap" id="plot-card">
      <h3 style="margin:6px 0 10px">Plot</h3>
      <div class="viz">
        <svg id="plot" viewBox="0 0 640 420" aria-label="Q vs h"></svg>
      </div>
    </section>

  </section>

</main>

<footer class="site-footer">
  <div class="container">
    <a href="../index.html" class="back-home"><span class="chev">←</span> Home</a>
  </div>
</footer>

<script>
  const $ = id => document.getElementById(id);
  const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
  const fmt = (x, d=3) => (Number.isFinite(x) ? x.toFixed(d) : "—");

  // Internal ranges (not shown to user)
  const R = {
    D1: {min:50, max:100, step:1},
    D2: {min:20, max:40, step:1},
    SG: {min:0.75, max:0.90, step:0.01},
    h:  {min:0, max:100, step:1}
  };

  // gravity fixed
  const g = 9.81;

  const state = { D1mm: 75, D2mm: 35, SG: 0.80, hmm: 40 };

  function area_m2(Dmm){
    const D = Dmm / 1000;
    return Math.PI * D * D / 4;
  }

  function Q_m3s({D1mm, D2mm, SG, hmm}){
    const D1 = D1mm / 1000;
    const D2 = D2mm / 1000;
    const h  = hmm  / 1000;

    const beta = D2 / D1;
    const denom = 1 - Math.pow(beta, 4);
    const oneMinusSG = 1 - SG;

    if(!(D1>0 && D2>0 && D2 < D1 && denom>0 && oneMinusSG>0 && h>=0)) return NaN;

    const k = (Math.PI*Math.PI*Math.pow(D2,4) * g * h * oneMinusSG) / (8 * denom);
    return Math.sqrt(k);
  }

  function setRanges(){
    $("D1").min = R.D1.min; $("D1").max = R.D1.max; $("D1").step = R.D1.step;
    $("D1_s").min = R.D1.min; $("D1_s").max = R.D1.max; $("D1_s").step = R.D1.step;

    $("D2").min = R.D2.min; $("D2").max = R.D2.max; $("D2").step = R.D2.step;
    $("D2_s").min = R.D2.min; $("D2_s").max = R.D2.max; $("D2_s").step = R.D2.step;

    $("SG").min = R.SG.min; $("SG").max = R.SG.max; $("SG").step = R.SG.step;
    $("SG_s").min = R.SG.min; $("SG_s").max = R.SG.max; $("SG_s").step = R.SG.step;

    $("h").min = R.h.min; $("h").max = R.h.max; $("h").step = R.h.step;
    $("h_s").min = R.h.min; $("h_s").max = R.h.max; $("h_s").step = R.h.step;
  }

  function syncUIFromState(){
    $("D1").value = state.D1mm; $("D1_s").value = state.D1mm;
    $("D2").value = state.D2mm; $("D2_s").value = state.D2mm;
    $("SG").value = state.SG.toFixed(2); $("SG_s").value = state.SG.toFixed(2);
    $("h").value  = state.hmm; $("h_s").value  = state.hmm;
  }

  function readStateFromUI(){
    state.D1mm = clamp(+($("D1").value||0), R.D1.min, R.D1.max);
    state.D2mm = clamp(+($("D2").value||0), R.D2.min, R.D2.max);
    state.SG   = clamp(+($("SG").value||0.8), R.SG.min, R.SG.max);
    state.hmm  = clamp(+($("h").value||0), R.h.min, R.h.max);
    syncUIFromState();
  }

  function updateOutputs(){
    const Q = Q_m3s(state);
    const Qml = Q * 1e6;

    $("Q_ml").textContent = Number.isFinite(Qml) ? `${fmt(Qml,0)} mL/s` : "—";

    const A1 = area_m2(state.D1mm);
    const A2 = area_m2(state.D2mm);
    const V1 = (Number.isFinite(Q) && A1>0) ? Q / A1 : NaN;
    const V2 = (Number.isFinite(Q) && A2>0) ? Q / A2 : NaN;

    $("V1").textContent = Number.isFinite(V1) ? `${fmt(V1,4)} m/s` : "—";
    $("V2").textContent = Number.isFinite(V2) ? `${fmt(V2,4)} m/s` : "—";
  }

  // ========= plot =========
  const svg = d3.select("#plot");
  const W = 640, H = 420;
  const M = {l: 78, r: 18, t: 18, b: 66};
  const PW = W - M.l - M.r;
  const PH = H - M.t - M.b;

  const HX = [0, 100];     // mm
  const QY = [0, 1200];    // mL/s

  const x = d3.scaleLinear().domain(HX).range([0, PW]);
  const y = d3.scaleLinear().domain(QY).range([PH, 0]);

  const gPlot = svg.append("g").attr("transform", `translate(${M.l},${M.t})`);

  gPlot.append("rect").attr("x",0).attr("y",0).attr("width",PW).attr("height",PH).attr("fill","#fff");

  gPlot.append("g").attr("class","axis").attr("transform",`translate(0,${PH})`).call(d3.axisBottom(x).ticks(6));
  gPlot.append("g").attr("class","axis").call(d3.axisLeft(y).ticks(6));

  gPlot.append("text")
    .attr("class","axis-title")
    .attr("x", PW/2).attr("y", PH + 50)
    .attr("text-anchor","middle")
    .text("Manometer reading, h (mm)");

  const Y_TITLE_PAD = 15;
  gPlot.append("text")
    .attr("class","axis-title")
    .attr("transform","rotate(-90)")
    .attr("x", -PH/2)
    .attr("y", -(Y_TITLE_PAD + 48))
    .attr("text-anchor","middle")
    .text("Volumetric flow rate, Q (mL/s)");

  gPlot.append("line")
    .attr("class","zeroline")
    .attr("x1",0).attr("x2",PW)
    .attr("y1",y(0)).attr("y2",y(0));

  const curvePath = gPlot.append("path").attr("class","curve");
  const pt = gPlot.append("circle").attr("class","dragpt").attr("r",6);

  const line = d3.line()
    .defined(d => Number.isFinite(d.Qml))
    .x(d => x(d.hmm))
    .y(d => y(clamp(d.Qml, QY[0], QY[1])));

  const hit = gPlot.append("rect")
    .attr("class","hit")
    .attr("x",0).attr("y",0).attr("width",PW).attr("height",PH);

  hit.call(
    d3.drag().on("drag", (event) => {
      const hmm = clamp(Math.round(x.invert(event.x)), HX[0], HX[1]);
      state.hmm = hmm;
      syncUIFromState();
      render();
    })
  );

  function updateCurve(){
    const pts = [];
    for(let hmm=HX[0]; hmm<=HX[1]; hmm+=1){
      const Q = Q_m3s({...state, hmm});
      pts.push({hmm, Qml: Q*1e6});
    }
    curvePath.attr("d", line(pts));
  }

  function updatePoint(){
    const Q = Q_m3s(state);
    const Qml = Q*1e6;
    pt.attr("cx", x(state.hmm))
      .attr("cy", y(clamp(Number.isFinite(Qml)?Qml:0, QY[0], QY[1])));
  }

  function render(){
    updateCurve();
    updatePoint();
    updateOutputs();
  }

  function bindPair(numId, rangeId, key){
    const n = $(numId), s = $(rangeId);
    n.addEventListener("input", ()=>{ readStateFromUI(); render(); });
    s.addEventListener("input", ()=>{ state[key] = +s.value; syncUIFromState(); render(); });
  }

  // feedback context
  (function(){
    const FEEDBACK = { course: "ME 310", sim: "Flow in a Variable-Area Pipe" };
    document.addEventListener("DOMContentLoaded", () => {
      const url = new URL("../feedback.html", location.href);
      url.searchParams.set("course", FEEDBACK.course);
      url.searchParams.set("sim", FEEDBACK.sim);
      document.querySelectorAll("a.feedback-link").forEach(a => {
        a.href = url.toString();
        try { localStorage.setItem("fb_ctx", JSON.stringify(FEEDBACK)); } catch {}
      });
    });
  })();

  // init
  setRanges();
  syncUIFromState();
  bindPair("D1","D1_s","D1mm");
  bindPair("D2","D2_s","D2mm");
  bindPair("SG","SG_s","SG");
  bindPair("h","h_s","hmm");
  render();
</script>
</body>
</html>
