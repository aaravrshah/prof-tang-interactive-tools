<!-- /me310/isentropic.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Isentropic Flow Functions for an Ideal Gas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    /* Keep MathJax sizing consistent across pages */
    window.MathJax = { chtml:{ scale:0.9 }, options:{ renderActions:{ addMenu:[] } } };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    /* Page-specific only */
    .top-grid{display:grid;gap:12px}
    @media (min-width:1024px){ .top-grid{grid-template-columns:1.5fr .9fr} }

    .eqbig{margin-top:2px} /* tiny breathing room line-to-line */

    /* Plot typography */
    .viz .axis text{font-size:15px}
    .viz .axis-title{font-size:16px}
    .curve-label{font-size:14px;paint-order:stroke;stroke:#fff;stroke-width:3px;stroke-linejoin:round}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <div class="header-row">
        <h1 style="margin:0">Isentropic Flow Functions for an Ideal Gas</h1>
        <a class="btn primary feedback-link" href="../feedback.html" target="_blank" rel="noopener">Send feedback</a>
      </div>
    </div>
  </header>

  <main class="container">
    <nav class="back-row">
      <a href="../index.html" class="back-home" aria-label="Back to home"><span class="chev">←</span> Home</a>
    </nav>

    <!-- Equations (left) + Inputs (right) -->
    <section class="top-grid">
      <!-- Equations -->
      <div class="card">
        <div class="eqwrap">
          <!-- Match Moody heading style -->
          <div class="note title-xl" style="margin-bottom:10px"><b>Isentropic flow functions (ideal gas)</b></div>

          <!-- Line 1: T/T0 & p/p0 -->
          <div class="eqbig">
            \( \displaystyle
                \frac{T}{T_0}=\Big(1+\frac{k-1}{2}\mathrm{Ma}^{2}\Big)^{-1}, \quad
                \frac{p}{p_0}=\Big(1+\frac{k-1}{2}\mathrm{Ma}^{2}\Big)^{-\frac{k}{k-1}}.
            \)
          </div>

          <!-- Line 2: rho/rho0 & A/A* (textbook formatting) -->
          <div class="eqbig" style="margin-top:8px">
            \( \displaystyle
              \frac{\rho}{\rho_0}=\Big(1+\frac{k-1}{2}\mathrm{Ma}^{2}\Big)^{-\frac{1}{k-1}}, \quad
              \frac{A}{A^{*}}=\frac{1}{\mathrm{Ma}}
              \left[\frac{2}{k+1}\left(1+\frac{k-1}{2}\mathrm{Ma}^{2}\right)\right]^{\frac{k+1}{2(k-1)}}.
            \)
          </div>

          <div class="note" style="margin-top:10px">
            <b>Symbols</b>
            <div class="symgrid">
              <ul>
                <li><b>Ma</b> — Mach number (flow speed / local speed of sound)</li>
                <li><b>k</b> — specific heat ratio (Cp/Cv)</li>
                <li><b>T</b>, <b>p</b>, <b>ρ</b> — local <i>static</i> temperature, pressure, density</li>
                <li><b>T₀</b>, <b>p₀</b>, <b>ρ₀</b> — <i>stagnation (total)</i> values</li>
              </ul>
              <ul>
                <li><b>A</b> — area at the location where the Mach number is Ma</li>
                <li><b>A*</b> — area that <i>would correspond to</i> Ma = 1 (critical/choked area)</li>
              </ul>
            </div>
            <div style="margin-top:8px">
              Bernoulli equation for incompressible flow is typically applicable when \( \mathrm{Ma} \lesssim 0.28 \) (≈ 2% pressure error).
            </div>
          </div>
        </div>
      </div>

      <!-- Inputs (slimmer) -->
      <div class="card">
        <div class="controls">
          <div class="ctl">
            <label>Ma (0.10–10.00)</label>
            <input id="ma" class="num-sm" type="number" min="0.10" max="10.00" step="0.01" value="1.00" />
          </div>

          <div class="ctl">
            <label>k (specific heat ratio)</label>
            <select id="k">
              <option value="1.67">1.67 — monatomic (e.g., He, Ne &amp; Ar)</option>
              <option value="1.40" selected>1.40 — diatomic (e.g., air: N₂ &amp; O₂)</option>
              <option value="1.33">1.33 — triatomic (e.g., CO₂)</option>
            </select>
          </div>

          <!-- Live mini readout (size comes from shared CSS) -->
          <div class="ctl">
            <label>Current values</label>
            <div class="kpi">
              <div><div class="lab">T/T₀</div><div id="kpi_TT0" class="val">—</div></div>
              <div><div class="lab">p/p₀</div><div id="kpi_pp0" class="val">—</div></div>
              <div><div class="lab">ρ/ρ₀</div><div id="kpi_rhorho0" class="val">—</div></div>
              <div><div class="lab">A/A*</div><div id="kpi_AA" class="val">—</div></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Plot -->
    <section class="card" style="margin-top:12px">
      <div id="plot" class="viz"></div>

      <div class="legend" style="margin-top:8px">
        <span class="sw" style="background:#ef4444"></span> T/T₀
        <span class="sw" style="background:#22c55e"></span> p/p₀
        <span class="sw" style="background:#3b82f6"></span> ρ/ρ₀
        <span class="sw" style="background:#8b5cf6"></span> A/A*
      </div>

      <div class="note" style="margin-top:8px">
        Curves show static-to-stagnation ratios vs Ma for the chosen k. Drag anywhere across the plot to change Ma.
      </div>

      <div id="readout" class="note" style="margin-top:8px"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <a href="../index.html" class="back-home"><span class="chev">←</span> Home</a>
    </div>
  </footer>

  <script>
    /* ===== math ===== */
    function isoRatios(Ma, k){
      const TT0 = 1/(1 + ((k-1)/2)*Ma*Ma);
      return { T_T0:TT0, p_p0:Math.pow(TT0, k/(k-1)), r_r0:Math.pow(TT0, 1/(k-1)) };
    }
    function areaRatio(Ma, k){
      const term = (2/(k+1))*(1 + ((k-1)/2)*Ma*Ma);
      return (1/Ma) * Math.pow(term, (k+1)/(2*(k-1)));
    }
    function maAtArea(target, k, lo=1.0001, hi=10){
      if (areaRatio(hi,k) < target) return null;
      for (let i=0;i<50;i++){
        const mid = 0.5*(lo+hi);
        const val = areaRatio(mid,k);
        if (Math.abs(val-target) < 1e-6) return mid;
        if (val >= target) hi = mid; else lo = mid;
      }
      return 0.5*(lo+hi);
    }

    /* ===== plot ===== */
    let kVal = 1.40, MaMark = 1.00;

    const plotEl = document.getElementById('plot');
    function size(){ const w = plotEl.clientWidth || 760; const h = 540; return { w:Math.max(620,w), h, m:64 }; }

    function drawMain(){
      const {w,h,m} = size();
      d3.select('#plot').html('');
      const svg = d3.select('#plot').append('svg').attr('width', w).attr('height', h).attr('viewBox',`0 0 ${w} ${h}`);

      // Scales: Ma log, left ratios 0→1, right A/A* 0→10
      const MaMin=0.10, MaMax=10.0;
      const x  = d3.scaleLog().domain([MaMin,MaMax]).range([m, w-m]).clamp(true);
      const yL = d3.scaleLinear().domain([0,1]).range([h-m, m]).nice();
      const yR = d3.scaleLinear().domain([0,10]).range([h-m, m]).nice();

      // Axes
      const xTicks = [0.1,0.5,1,5,10];
      svg.append('g').attr('class','axis').attr('transform',`translate(0,${h-m})`)
         .call(d3.axisBottom(x).tickValues(xTicks).tickFormat(d3.format("~g")));
      svg.append('g').attr('class','axis').attr('transform',`translate(0,${m})`)
         .call(d3.axisTop(x).tickValues(xTicks).tickFormat(d3.format("~g")));
      svg.append('g').attr('class','axis').attr('transform',`translate(${m},0)`).call(d3.axisLeft(yL).ticks(10));
      svg.append('g').attr('class','axis').attr('transform',`translate(${w-m},0)`).call(d3.axisRight(yR).ticks(10));

      // Axis titles
      svg.append('text').attr('class','axis-title').attr('x', w/2).attr('y', h-10)
         .attr('text-anchor','middle').text('Ma');
      svg.append('text').attr('class','axis-title').attr('x', -(h/2)).attr('y', 18)
         .attr('text-anchor','middle').attr('transform','rotate(-90)').text('T/T₀, p/p₀, ρ/ρ₀');
      const rx = w - 22, ry = h/2;  /* flip orientation to match Moody */
      svg.append('text').attr('class','axis-title').attr('x', rx).attr('y', ry)
         .attr('text-anchor','middle').attr('transform',`rotate(-90 ${rx} ${ry})`).text('A/A*');

      // Grid
      xTicks.forEach(t => svg.append('line').attr('x1',x(t)).attr('x2',x(t)).attr('y1',m).attr('y2',h-m).attr('stroke','#0001'));
      yL.ticks(20).forEach(t => svg.append('line').attr('x1',m).attr('x2',w-m).attr('y1',yL(t)).attr('y2',yL(t)).attr('stroke','#0001'));

      // Data along Ma (log-stepped)
      const MaVals = []; for(let M=MaMin; M<=MaMax+1e-9; M*=1.03) MaVals.push(M);
      const rows = MaVals.map(M=>({Ma:M, ...isoRatios(M,kVal)}));

      // Curves (left axis)
      const cT='#ef4444', cP='#22c55e', cR='#3b82f6', cA='#8b5cf6';
      const L  = key => d3.line().x(d=>x(d.Ma)).y(d=>yL(d[key]))(rows);
      svg.append('path').attr('d', L('T_T0')).attr('stroke',cT).attr('stroke-width',2).attr('fill','none');
      svg.append('path').attr('d', L('p_p0')).attr('stroke',cP).attr('stroke-width',2).attr('fill','none');
      svg.append('path').attr('d', L('r_r0')).attr('stroke',cR).attr('stroke-width',2).attr('fill','none');

      // A/A* curve on right axis, clipped to 10
      const ptsA = [];
      for (let i=0;i<MaVals.length;i++){
        const M = MaVals[i];
        const A = areaRatio(M, kVal);
        if (A > 10){
          const Mx = maAtArea(10, kVal, Math.max(1.0001, MaVals[i-1]||1.0001), M);
          if (Mx){ ptsA.push([x(Mx), yR(10)]); }
          break;
        }
        ptsA.push([x(M), yR(A)]);
      }
      svg.append('path').attr('d', d3.line()(ptsA)).attr('stroke',cA).attr('stroke-width',2).attr('fill','none');

      // Dynamic labels that move with k
      const lblT = isoRatios(1.6, kVal).T_T0, lblP = isoRatios(1.2, kVal).p_p0, lblR = isoRatios(1.0, kVal).r_r0, lblA = areaRatio(2.3, kVal);
      svg.append('text').attr('class','curve-label').attr('x', x(1.6)).attr('y', yL(lblT)).attr('fill', cT).text('T/T₀');
      svg.append('text').attr('class','curve-label').attr('x', x(1.2)).attr('y', yL(lblP)).attr('fill', cP).text('p/p₀');
      svg.append('text').attr('class','curve-label').attr('x', x(1.05)).attr('y', yL(lblR)).attr('fill', cR).text('ρ/ρ₀');
      if (lblA <= 10){
        svg.append('text').attr('class','curve-label').attr('x', x(2.3)).attr('y', yR(lblA)).attr('fill', cA).text('A/A*');
      }

      // Draggable vertical line & probe dots
      const dragTo = (ev)=>{ const xm = Math.max(m, Math.min(w-m, ev.x)); setMa(x.invert(xm)); };
      const line = svg.append('line')
        .attr('x1', x(MaMark)).attr('x2', x(MaMark)).attr('y1', m).attr('y2', h-m)
        .attr('stroke','#111').attr('stroke-width',2).attr('stroke-dasharray','5 3')
        .style('cursor','ew-resize')
        .call(d3.drag().on('drag', dragTo));
      svg.append('rect').attr('x',m).attr('y',m).attr('width',w-2*m).attr('height',h-2*m)
         .attr('fill','transparent').style('cursor','ew-resize')
         .call(d3.drag().on('drag', dragTo));

      // Probe dots (match Moody style)
      const dotT = svg.append('circle').attr('r',7).attr('fill',cT).attr('stroke','#111');
      const dotP = svg.append('circle').attr('r',7).attr('fill',cP).attr('stroke','#111');
      const dotR = svg.append('circle').attr('r',7).attr('fill',cR).attr('stroke','#111');
      const dotA = svg.append('circle').attr('r',7).attr('fill',cA).attr('stroke','#111');

      function positionDots(){
        const s = isoRatios(MaMark, kVal);
        const A = areaRatio(MaMark, kVal);
        dotT.attr('cx', x(MaMark)).attr('cy', yL(s.T_T0)).style('display', null);
        dotP.attr('cx', x(MaMark)).attr('cy', yL(s.p_p0)).style('display', null);
        dotR.attr('cx', x(MaMark)).attr('cy', yL(s.r_r0)).style('display', null);
        if (A > yR.domain()[1]) { dotA.style('display','none'); }
        else { dotA.attr('cx', x(MaMark)).attr('cy', yR(A)).style('display', null); }
      }

      function refresh(){ line.attr('x1',x(MaMark)).attr('x2',x(MaMark)); positionDots(); }
      positionDots();
      updateReadout(); updateKPIs();
      return { refresh };
    }

    function updateReadout(){
      const s = isoRatios(MaMark, kVal);
      const AA = areaRatio(MaMark, kVal);
      const txt = [
        `<b>Ma</b> = ${MaMark.toFixed(2)}`,
        `<b>k</b> = ${kVal.toFixed(2)}`,
        `<b>T/T₀</b> = ${s.T_T0.toFixed(3)}`,
        `<b>p/p₀</b> = ${s.p_p0.toFixed(3)}`,
        `<b>ρ/ρ₀</b> = ${s.r_r0.toFixed(3)}`,
        `<b>A/A*</b> = ${AA.toFixed(3)}`
      ].join(' • ');
      document.getElementById('readout').innerHTML = txt;
    }

    function updateKPIs(){
      const s = isoRatios(MaMark, kVal);
      const AA = areaRatio(MaMark, kVal);
      document.getElementById('kpi_TT0').textContent   = s.T_T0.toFixed(3);
      document.getElementById('kpi_pp0').textContent    = s.p_p0.toFixed(3);
      document.getElementById('kpi_rhorho0').textContent= s.r_r0.toFixed(3);
      document.getElementById('kpi_AA').textContent     = AA.toFixed(3);
    }

    let mainAPI = drawMain();

    function setMa(val){
      const v = Math.max(0.10, Math.min(10.0, parseFloat(val)));
      MaMark = isFinite(v) ? v : MaMark;
      document.getElementById('ma').value = MaMark.toFixed(2);
      mainAPI.refresh(); updateReadout(); updateKPIs();
    }

    // Wiring
    document.getElementById('ma').addEventListener('input', e => setMa(e.target.value));
    document.getElementById('k').addEventListener('change', e => {
      kVal = parseFloat(e.target.value);
      mainAPI = drawMain(); // redraw so curve labels move with k
    });
    window.addEventListener('resize', ()=> { mainAPI = drawMain(); });
  </script>

  <!-- Auto-stamp feedback link with page context -->
  <script>
    const FEEDBACK = { course: 'ME 310', sim: 'Isentropic Flow Functions for an Ideal Gas' };
    document.addEventListener('DOMContentLoaded', () => {
      const url = new URL('../feedback.html', location.href);
      if (FEEDBACK.course) url.searchParams.set('course', FEEDBACK.course);
      if (FEEDBACK.sim)    url.searchParams.set('sim',    FEEDBACK.sim);
      document.querySelectorAll('a.feedback-link').forEach(a => {
        a.href = url.toString();
        try { localStorage.setItem('fb_ctx', JSON.stringify(FEEDBACK)); } catch {}
      });
    });
  </script>
</body>
</html>
