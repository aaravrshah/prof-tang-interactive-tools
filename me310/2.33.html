<!-- /me310/2.33.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hydrostatic Pressure in a Liquid Undergoing Rigid-Body Rotation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- MathJax -->
  <script>
    window.MathJax = { chtml:{scale:0.9}, options:{renderActions:{addMenu:[]}} };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    .site-header .container{padding-top:20px;padding-bottom:20px}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #ffffff55;
         background:rgba(255,255,255,.12);color:#fff;text-decoration:none}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.primary:hover{filter:brightness(1.06)}

    .back-row{display:flex;align-items:center;margin:12px 0 14px}
    .back-home{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;
      background:#fff;color:#0ea5e9;text-decoration:none;font-size:14px;
    }
    .back-home:hover{background:#f0f9ff}
    .back-home .chev{font-size:16px;line-height:1}

    /* ===== Top layout: equations + schematic ===== */
    .top-grid{
      display:grid;
      gap:14px;
      margin-top:10px;
    }
    .left-col{display:flex;flex-direction:column;gap:12px}
    .side-col{display:flex;flex-direction:column;gap:12px}

    @media (min-width:900px){
      .top-grid{
        grid-template-columns:minmax(0,2.1fr) minmax(260px,0.9fr);
        align-items:flex-start;
      }
      .side-col{
        position:sticky;
        top:96px;
        align-self:flex-start;
      }
    }

    .note{font-size:14px;color:#4b5563}

    /* ===== Kill scrollbars on calc cards (override any styles.css behavior) ===== */
    .card.eq-card,
    .card.schematic-card{
      max-height:none !important;
      height:auto !important;
      overflow:visible !important;
    }
    .card.eq-card *{
      overflow:visible !important;
    }

    .eq-card h2{margin:4px 0 6px}
    .eq-subtitle{
      margin:4px 0 6px;
      font-size:18px;
      font-weight:600;
    }
    .eqwrap{margin-bottom:10px}
    .eqwrap p{margin:4px 0}

    .eq-heading-row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:4px;
    }
    .eq-link{
      font-size:13px;
      color:#0ea5e9;
      text-decoration:none;
    }
    .eq-link:hover{text-decoration:underline}

    .schematic-card p{margin:0 0 6px;font-size:14px;color:#4b5563}
    .schematic-img{
      display:block;
      max-width:100%;
      height:auto;
      margin:8px auto;
      border-radius:6px;
    }

    /* ===== Inputs card ===== */
    .inputs-card{margin-top:18px}
    .inputs-card h2{margin:4px 0 10px}

    .inputs-row1,
    .inputs-row2{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    .inputs-row1 .ctl,
    .inputs-row2 .ctl{
      background:#fff;
      border-radius:10px;
      border:1px solid var(--line);
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1 1 260px;
    }

    .inputs-row1 label,
    .inputs-row2 label{
      font-size:13px;
      color:#4b5563;
    }

    .ctl-row{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .ctl-row input[type="range"]{flex:1}
    .ctl-row input[type="number"]{
      width:90px;
      max-width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--line);
      font-size:13px;
    }

    .coord-ctl .coord-row{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    .coord-ctl .axis-label{
      font-size:12px;
      color:#4b5563;
      margin-bottom:2px;
    }
    .coord-ctl .sub-ctl{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .coord-ctl .sub-ctl .ctl-row input[type="range"]{flex:1.2}
    .inputs-note{margin-top:10px}

    /* ===== Outputs card ===== */
    .outputs-card{margin-top:16px}
    .outputs-card h2{margin:4px 0 10px}
    .outputs-grid{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      margin-top:4px;
    }
    .out-box{
      flex:1 1 220px;
      background:#fff;
      border-radius:10px;
      border:1px solid var(--line);
      padding:10px 12px;
    }
    .out-label{font-size:13px;color:#6b7280;margin-bottom:4px}
    .out-value{font-size:18px;font-weight:600;color:#111827}

    /* ===== Plots ===== */
    .plots-card{margin-top:18px}
    .plots-card h2{margin:4px 0 10px}

    .plots-grid{
      display:grid;
      gap:14px;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    }
    .plot-panel{padding:4px 4px 0}

    .viz{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px}
    #plot-iso,#plot-center,#plot-bottom{width:100%;height:auto;display:block}

    .legend-block{margin-top:8px}
    .legend-row{margin-bottom:4px}
    .legend-item{display:inline-flex;align-items:center;gap:6px;margin-right:12px;font-size:13px;color:#334155}
    .legend-item .sw{display:inline-block;width:14px;height:14px;border-radius:3px;border:1px solid #0002}
    .legend-block .dim-note{font-size:13px;color:#6b7280;margin:0;line-height:1.4}

    svg .axis text{font-size:14px}
    svg .axis-title{font-size:16px}

    .drag-point{cursor:grab}
    .drag-overlay{cursor:pointer}
  </style>
</head>

<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <div class="header-row">
        <div>
          <h1 style="margin:0">Hydrostatic Pressure in a Liquid Undergoing Rigid-Body Rotation</h1>
          <p class="subtitle">
            Explore how the pressure field \(p(r,z)\) varies in a rotating cylindrical container.
          </p>
        </div>
        <a class="btn primary feedback-link" href="../feedback.html" target="_blank" rel="noopener">Send feedback</a>
      </div>
    </div>
  </header>

  <main class="container">
    <nav class="back-row">
      <a href="../index.html" class="back-home" aria-label="Back to home">
        <span class="chev">‚Üê</span> Home
      </a>
    </nav>

    <!-- Top section: equations + schematic -->
    <section class="top-grid">
      <!-- Left: equations -->
      <div class="left-col">
        <div class="card eq-card">
          <h2>Hydrostatic pressure equation</h2>
          <div class="eqwrap">
            <p class="note">
              For a liquid of density \( \rho \) in rigid-body rotation with angular velocity \( \omega \),
              the hydrostatic pressure distribution is
            </p>
            \[
              p(r,z) = \rho \frac{\omega^2 r^2}{2} - \rho g z + \text{constant}.
            \]
            <p class="note">
              The constant in this equation depends on the choice of \( z \)-origin and on the geometry and
              operating condition.
            </p>
          </div>

          <div class="eqwrap">
            <div class="eq-heading-row">
              <h3 class="eq-subtitle">Recall: Free surface</h3>
              <a href="2.32.html" class="eq-link">See derivation (Eq.&nbsp;2.32)</a>
            </div>
            <p class="note">
              For a liquid in a vertical cylindrical container of radius \( R \) undergoing rigid-body rotation
              with angular velocity \( \omega \), the free surface profile (no spilling) is
            </p>
            \[
              z = h(r) = \frac{\omega^2 r^2}{2g} + h_0,
              \quad \text{where} \quad
              h_0 = H - \frac{\omega^2 R^2}{4g}.
            \]
            <p class="note">That is,</p>
            \[
              z = h(r) = \frac{\omega^2 r^2}{2g}
                    + H - \frac{\omega^2 R^2}{4g}.
            \]
            <p class="note">
              Here \( H \) is the liquid depth when the tank is at rest.
            </p>
          </div>
        </div>

        <div class="card eq-card">
          <h3 class="eq-subtitle">Determining the constant in the hydrostatic pressure equation</h3>
          <div class="eqwrap">
            <p class="note">
              At \( r = 0 \) and \( z = h_0 \), the free surface is exposed to atmosphere, so
              \( p = p_{\text{atm}} = 0 \) (gauge pressure). Thus
            </p>
            \[
              p(r,z) = \rho \frac{\omega^2 r^2}{2} - \rho g z + \text{constant}
              \quad\Rightarrow\quad
              \text{constant} = \rho g h_0
              = \rho g\!\left(H - \frac{\omega^2 R^2}{4g}\right).
            \]
            <p class="note">Substituting back, the gauge pressure field is</p>
            \[
              \begin{aligned}
                p(r,z)
                  &= \rho \frac{\omega^2 r^2}{2} - \rho g z
                     + \rho g\!\left(H - \frac{\omega^2 R^2}{4g}\right) \\
                  &= \rho \frac{\omega^2}{4}\bigl(2r^2 - R^2\bigr) + \rho g(H - z).
              \end{aligned}
            \]
          </div>
        </div>

        <div class="card eq-card">
          <h3 class="eq-subtitle">Alternative form using local liquid depth</h3>
          <div class="eqwrap">
            <p class="note">
              The same expression can also be developed using \( p = \rho g\,\Delta h \), where
              \( \Delta h \) is the local liquid depth. For a point at \( (r,z) \),
            </p>
            \[
              \Delta h = h - z
                       = \frac{\omega^2 r^2}{2g} + h_0 - z.
            \]
            <p class="note">Therefore,</p>
            \[
              \begin{aligned}
                p(r,z)
                  &= \rho g\,\Delta h
                   = \rho g(h - z)
                   = \rho g\!\left(\frac{\omega^2 r^2}{2g} + h_0 - z\right) \\
                  &= \rho g\!\left(\frac{\omega^2 r^2}{2g} + H
                        - \frac{\omega^2 R^2}{4g} - z\right) \\
                  &= \rho \frac{\omega^2}{4}\bigl(2r^2 - R^2\bigr) + \rho g(H - z).
              \end{aligned}
            \]
          </div>
        </div>
      </div>

      <!-- Right: schematic -->
      <div class="side-col">
        <div class="card schematic-card">
          <h2 style="margin:4px 0 8px">Schematic</h2>
          <p>
            Vertical cylindrical container of radius \( R \) rotating at angular velocity \( \omega \).
            The bottom is at \( z = 0 \); the initial liquid depth at rest is \( H \).
          </p>
          <img src="../assets/thumbs/2.33.png"
               alt="Schematic of rotating cylindrical container"
               class="schematic-img">
          <p>
            During rotation, the free surface \( z = h(r) \) becomes parabolic. The depth at the center is
            \( h_0 = H - \dfrac{\omega^2 R^2}{4g} \).
          </p>
        </div>
      </div>
    </section>

    <!-- Inputs -->
    <section class="card inputs-card">
      <h2>Inputs</h2>

      <div class="inputs-row1">
        <div class="ctl">
          <label for="omegaSlider">Angular velocity \( \omega \) (rad/s)</label>
          <div class="ctl-row">
            <input id="omegaSlider" type="range" min="0" max="10" step="0.1">
            <input id="omegaInput" type="number" step="0.1">
          </div>
        </div>

        <div class="ctl">
          <label for="RSlider">Cylinder radius \( R \) (m)</label>
          <div class="ctl-row">
            <input id="RSlider" type="range" min="0.10" max="0.50" step="0.01">
            <input id="RInput" type="number" step="0.001">
          </div>
        </div>

        <div class="ctl">
          <label for="HSlider">Liquid depth at rest (i.e., \( \omega = 0 \)), \( H \) (m)</label>
          <div class="ctl-row">
            <input id="HSlider" type="range" min="0.70" max="1.30" step="0.01">
            <input id="HInput" type="number" step="0.001">
          </div>
        </div>
      </div>

      <div class="inputs-row2" style="margin-top:10px">
        <div class="ctl coord-ctl">
          <label>Coordinate for \( p : (r,z) \) (m)</label>
          <div class="coord-row">
            <div class="sub-ctl">
              <span class="axis-label">\( r \)</span>
              <div class="ctl-row">
                <input id="rSlider" type="range" min="0.00" max="0.50" step="0.005">
                <input id="rInput" type="number" step="0.001">
              </div>
            </div>
            <div class="sub-ctl">
              <span class="axis-label">\( z \)</span>
              <div class="ctl-row">
                <input id="zSlider" type="range" min="0.00" max="1.30" step="0.01">
                <input id="zInput" type="number" step="0.001">
              </div>
            </div>
          </div>
        </div>
      </div>

      <p class="note inputs-note">
        Density is fixed at \( \rho = 998.2~\text{kg/m}^3 \) (water). The coordinate \( (r,z) \) defines one of the
        three constant-pressure lines. You can also click or drag the blue point in the first plot to adjust \( r \) and \( z \).
      </p>
    </section>

    <!-- Outputs -->
    <section class="card outputs-card">
      <h2>Outputs at \( (r,z) \)</h2>
      <p class="note">
        At the blue point \( (r,z) \), the gauge pressure is \( p(r,z) \) and the local liquid depth is
        \( \Delta h = h(r) - z \).
      </p>
      <div class="outputs-grid">
        <div class="out-box">
          <div class="out-label">Gauge pressure \( p(r,z) \)</div>
          <div class="out-value"><span id="pOut">0.00</span> kPa</div>
        </div>
        <div class="out-box">
          <div class="out-label">Local liquid depth \( \Delta h = h(r) - z \)</div>
          <div class="out-value"><span id="dhOut">0.000</span> m</div>
        </div>
      </div>
    </section>

    <!-- Plots -->
    <section class="card plots-card">
      <h2>Pressure visualizations</h2>
      <div class="plots-grid">
        <div class="plot-panel">
          <h3 style="margin:4px 0 6px">Constant-pressure lines</h3>
          <div class="viz">
            <svg id="plot-iso" viewBox="0 0 360 460" aria-label="Constant-pressure lines"></svg>
          </div>
          <div id="legend-iso" class="legend-block"></div>
        </div>

        <div class="plot-panel">
          <h3 style="margin:4px 0 6px">\(p\) vs \(z\) at fixed \(r\)</h3>
          <div class="viz">
            <svg id="plot-center" viewBox="0 0 360 460" aria-label="p vs z at fixed r"></svg>
          </div>
          <div id="legend-center" class="legend-block"></div>
        </div>

        <div class="plot-panel">
          <h3 style="margin:4px 0 6px">\(p\) vs \(r\) at fixed \(z\)</h3>
          <div class="viz">
            <svg id="plot-bottom" viewBox="0 0 360 460" aria-label="p vs r at fixed z"></svg>
          </div>
          <div id="legend-bottom" class="legend-block"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const g   = 9.81;
    const rho = 998.2; // kg/m^3
    const colors = ['#2563eb','#f97316','#10b981'];

    const state = {
      omega: 8.0,
      R:     0.4,
      H:     1.0,
      r:     0.3,
      z:     0.8
    };

    let omegaSlider, omegaInput,
        RSlider, RInput,
        HSlider, HInput,
        rSlider, rInput,
        zSlider, zInput,
        pOut, dhOut;

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    function freeSurfaceH0(omega,R,H){
      return H - (omega*omega*R*R)/(4*g);
    }

    function freeSurfaceAtR(omega,R,H,r){
      return H + (omega*omega/(4*g))*(2*r*r - R*R);
    }

    function pGauge(omega,R,H,r,z){
      return rho * ( (omega*omega/4)*(2*r*r - R*R) + g*(H - z) );
    }

    function enforceStateBounds(){
      state.omega = clamp(state.omega,0,10);
      state.R     = clamp(state.R,0.10,0.50);
      state.H     = clamp(state.H,0.70,1.30);
      state.r     = clamp(state.r,0,state.R);

      const hR = freeSurfaceAtR(state.omega,state.R,state.H,state.r);
      const zMax = Math.max(0,hR);
      state.z = clamp(state.z,0,zMax);
    }

    function applyStateToInputs(){
      omegaSlider.value = state.omega;
      omegaInput.value  = state.omega.toFixed(2);

      RSlider.value = state.R;
      RInput.value  = state.R.toFixed(3);

      HSlider.value = state.H;
      HInput.value  = state.H.toFixed(3);

      rSlider.max = state.R.toFixed(3);

      const zMax = freeSurfaceAtR(state.omega,state.R,state.H,state.r);
      zSlider.max = Math.max(0,zMax).toFixed(3);

      rSlider.value = state.r;
      rInput.value  = state.r.toFixed(3);

      zSlider.value = state.z;
      zInput.value  = state.z.toFixed(3);
    }

    function initPlot(id, xLabel, yLabel){
      const svg = d3.select('#'+id);
      const W = 360, Hh = 460;
      const margin = {top:20,right:16,bottom:60,left:64};
      const iw = W - margin.left - margin.right;
      const ih = Hh - margin.top - margin.bottom;

      svg.attr('viewBox',`0 0 ${W} ${Hh}`);

      const gMain = svg.append('g').attr('transform',`translate(${margin.left},${margin.top})`);
      const axesG = gMain.append('g').attr('class','axes');
      const curvesG = gMain.append('g').attr('class','curves');

      const xAxisG = axesG.append('g')
        .attr('class','axis axis--x')
        .attr('transform',`translate(0,${ih})`);
      const yAxisG = axesG.append('g').attr('class','axis axis--y');

      axesG.append('text')
        .attr('class','axis-title')
        .attr('x', iw/2)
        .attr('y', ih + 44)
        .attr('text-anchor','middle')
        .text(xLabel);

      axesG.append('text')
        .attr('class','axis-title')
        .attr('transform',`translate(-50,${ih/2}) rotate(-90)`)
        .attr('text-anchor','middle')
        .text(yLabel);

      const xScale = d3.scaleLinear().range([0,iw]);
      const yScale = d3.scaleLinear().range([ih,0]);

      const line = d3.line()
        .defined(d => Number.isFinite(d.y))
        .x(d=>xScale(d.x))
        .y(d=>yScale(d.y));

      return {svg,gMain,axesG,curvesG,xAxisG,yAxisG,xScale,yScale,line,iw,ih};
    }

    const isoPlot    = initPlot('plot-iso','r (m)','z (m)');
    const centerPlot = initPlot('plot-center','z (m)','p (kPa)');
    const bottomPlot = initPlot('plot-bottom','r (m)','p (kPa)');

    let dragPoint = null;
    let dragOverlay = null;

    // --- Constant-pressure lines plot: cut off ONLY the z<0 part (no water), keep the rest
    function updateIso(){
      const {omega,R,H,r: rRef,z: zRef} = state;

      const h0 = freeSurfaceH0(omega,R,H);

      let p1 = pGauge(omega,R,H,rRef,zRef);
      if(p1 < 0) p1 = 0;

      const p2 = 0;
      const p3 = pGauge(omega,R,H,0,0.5*h0);

      const pConsts = [p1,p2,p3];

      const curves = pConsts.map((pConst,idx)=>{
        const pts = [];
        const N = 220;

        let prevR = null, prevZ = null;

        for(let i=0;i<=N;i++){
          const r = R * i/N;
          const z = H + (omega*omega/(4*g))*(2*r*r - R*R) - pConst/(rho*g);

          const prevPos = (prevZ !== null) && (prevZ >= 0);
          const currPos = (z >= 0);

          // crossing z=0: add intersection point and break
          if(prevZ !== null && prevR !== null && (prevPos !== currPos)){
            const rCross = prevR + (0 - prevZ) * (r - prevR) / (z - prevZ);
            pts.push({x:rCross, y:0});
            pts.push({x:rCross, y:NaN});
          }

          if(currPos){
            pts.push({x:r,y:z});
          }else{
            pts.push({x:r,y:NaN});
          }

          prevR = r;
          prevZ = z;
        }

        return {key:'c'+idx, pts};
      });

      // y max ignoring NaNs
      let zMax = 0;
      curves.forEach(c=>{
        c.pts.forEach(p=>{
          if(Number.isFinite(p.y) && p.y > zMax) zMax = p.y;
        });
      });

      isoPlot.xScale.domain([0,R]);
      isoPlot.yScale.domain([0, zMax*1.02]);

      isoPlot.xAxisG.call(d3.axisBottom(isoPlot.xScale).ticks(5));
      isoPlot.yAxisG.call(d3.axisLeft(isoPlot.yScale).ticks(5));

      const paths = isoPlot.curvesG.selectAll('path.curve')
        .data(curves, d=>d.key);

      paths.enter()
        .append('path')
        .attr('class','curve')
        .attr('fill','none')
        .attr('stroke-width',2.2)
        .merge(paths)
        .attr('stroke',(d,i)=>colors[i])
        .attr('d',d=>isoPlot.line(d.pts));

      paths.exit().remove();

      if(dragPoint){
        dragPoint
          .attr('cx', isoPlot.xScale(rRef))
          .attr('cy', isoPlot.yScale(zRef));
      }

      const legend = document.getElementById('legend-iso');

      const labels = [
        '\\( p_1 = p(r,z) \\)',
        '\\( p_2 = p(0,h_0) \\;\\text{(free surface)} \\)',
        '\\( p_3 = p(0, h_0/2) \\)'
      ];

      const itemsHTML = labels.map((txt,i)=>
        `<span class="legend-item"><span class="sw" style="background:${colors[i]}"></span><span>${txt}</span></span>`
      ).join('');

      legend.innerHTML =
        `<div class="legend-row">${itemsHTML}</div>` +
        `<p class="dim-note">
          Three constant-pressure lines. \(p_2\) lies on the free surface where \(p(0,h_0)=0\).
          \(p_1\) uses the selected point \((r,z)\), and \(p_3\) uses the point \((0, h_0/2)\)
          on the axis (half the free-surface height).
        </p>`;

      if(window.MathJax && window.MathJax.typesetPromise){
        MathJax.typesetPromise([legend]);
      }
    }

    function initIsoInteraction(){
      dragPoint = isoPlot.curvesG.append('circle')
        .attr('class','drag-point')
        .attr('r',8)
        .attr('fill',colors[0])
        .attr('stroke','#ffffff')
        .attr('stroke-width',2.2);

      dragOverlay = isoPlot.gMain.append('rect')
        .attr('class','drag-overlay')
        .attr('x',0)
        .attr('y',0)
        .attr('width',isoPlot.iw)
        .attr('height',isoPlot.ih)
        .attr('fill','transparent');

      const dragBehavior = d3.drag()
        .on('drag', function(event){
          const [mx,my] = d3.pointer(event, isoPlot.gMain.node());
          const rNew = isoPlot.xScale.invert(mx);
          const zNew = isoPlot.yScale.invert(my);
          setPointFromPlot(rNew,zNew);
        });

      dragPoint.call(dragBehavior);

      dragOverlay
        .on('click', function(event){
          const [mx,my] = d3.pointer(event, isoPlot.gMain.node());
          const rNew = isoPlot.xScale.invert(mx);
          const zNew = isoPlot.yScale.invert(my);
          setPointFromPlot(rNew,zNew);
        })
        .call(dragBehavior);
    }

    function setPointFromPlot(rNew,zNew){
      state.r = rNew;
      state.z = zNew;
      enforceStateBounds();
      applyStateToInputs();
      updateAllFromState();
    }

    function updateCenter(){
      const {omega,R,H,r: rRef} = state;

      const hR = freeSurfaceAtR(omega,R,H,rRef);
      const zMax = Math.max(0,hR);

      const N = 180;
      const pts = [];
      let pMax = 0;

      for(let i=0;i<=N;i++){
        const z = zMax * i/N;
        let p = 0;
        if(z <= hR + 1e-9){
          p = pGauge(omega,R,H,rRef,z)/1000;
          if(p < 0) p = 0;
        }
        pts.push({x:z,y:p});
        if(p > pMax) pMax = p;
      }

      const pPad = pMax*1.05;
      const yMax = (pPad <= 5) ? 5 : 20;

      centerPlot.xScale.domain([0,zMax]);
      centerPlot.yScale.domain([0,yMax]);

      centerPlot.xAxisG.call(d3.axisBottom(centerPlot.xScale).ticks(5));
      centerPlot.yAxisG.call(d3.axisLeft(centerPlot.yScale).ticks(5));

      const path = centerPlot.curvesG.selectAll('path.curve')
        .data([pts]);

      path.enter()
        .append('path')
        .attr('class','curve')
        .attr('fill','none')
        .attr('stroke-width',2.2)
        .merge(path)
        .attr('stroke',colors[0])
        .attr('d',centerPlot.line);

      path.exit().remove();

      const legend = document.getElementById('legend-center');
      legend.innerHTML =
        `<p class="dim-note">
          Gauge pressure \(p(r,z)\) along a vertical line at the chosen \(r\),
          from \(z=0\) up to the free surface at \(z=h(r)\), where \(p=0\).
        </p>`;

      if(window.MathJax && window.MathJax.typesetPromise){
        MathJax.typesetPromise([legend]);
      }
    }

    // Third plot: KEEP the p=0 flat segment where there is no water at that z (this is correct behavior)
    function updateBottom(){
      const {omega,R,H,z: zRef} = state;

      const N = 180;
      const pts = [];
      let pMax = 0;

      for(let i=0;i<=N;i++){
        const r = R * i/N;
        const hR = freeSurfaceAtR(omega,R,H,r);
        let p = 0;
        if(zRef <= hR + 1e-9){
          p = pGauge(omega,R,H,r,zRef)/1000;
          if(p < 0) p = 0;
        }else{
          p = 0;
        }
        pts.push({x:r,y:p});
        if(p > pMax) pMax = p;
      }

      const pPad = pMax*1.05;
      const yMax = (pPad <= 5) ? 5 : 20;

      bottomPlot.xScale.domain([0,R]);
      bottomPlot.yScale.domain([0,yMax]);

      bottomPlot.xAxisG.call(d3.axisBottom(bottomPlot.xScale).ticks(5));
      bottomPlot.yAxisG.call(d3.axisLeft(bottomPlot.yScale).ticks(5));

      const path = bottomPlot.curvesG.selectAll('path.curve')
        .data([pts]);

      path.enter()
        .append('path')
        .attr('class','curve')
        .attr('fill','none')
        .attr('stroke-width',2.2)
        .merge(path)
        .attr('stroke',colors[1])
        .attr('d',bottomPlot.line);

      path.exit().remove();

      const legend = document.getElementById('legend-bottom');
      legend.innerHTML =
        `<p class="dim-note">
          Gauge pressure \(p(r,z)\) along a horizontal line at the chosen \(z\),
          from \(r=0\) to \(r=R\). Where the line lies above the free surface, \(p=0\).
        </p>`;

      if(window.MathJax && window.MathJax.typesetPromise){
        MathJax.typesetPromise([legend]);
      }
    }

    function updateOutputs(){
      const {omega,R,H,r,z} = state;

      const hR = freeSurfaceAtR(omega,R,H,r);
      const pPa = pGauge(omega,R,H,r,z);
      const pKPa = Math.max(0,pPa)/1000;
      const dh = Math.max(0, hR - z);

      pOut.textContent  = pKPa.toFixed(2);
      dhOut.textContent = dh.toFixed(3);
    }

    function updateAllFromState(){
      enforceStateBounds();
      applyStateToInputs();
      updateIso();
      updateCenter();
      updateBottom();
      updateOutputs();
    }

    function handleSliderChange(){
      state.omega = parseFloat(omegaSlider.value);
      state.R     = parseFloat(RSlider.value);
      state.H     = parseFloat(HSlider.value);
      state.r     = parseFloat(rSlider.value);
      state.z     = parseFloat(zSlider.value);
      updateAllFromState();
    }

    function handleNumberChange(e){
      const id = e.target.id;
      let v = parseFloat(e.target.value);
      if(isNaN(v)) return;

      if(id === 'omegaInput'){ state.omega = v; omegaSlider.value = v; }
      else if(id === 'RInput'){ state.R = v; RSlider.value = v; }
      else if(id === 'HInput'){ state.H = v; HSlider.value = v; }
      else if(id === 'rInput'){ state.r = v; rSlider.value = v; }
      else if(id === 'zInput'){ state.z = v; zSlider.value = v; }

      updateAllFromState();
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      omegaSlider = document.getElementById('omegaSlider');
      omegaInput  = document.getElementById('omegaInput');
      RSlider     = document.getElementById('RSlider');
      RInput      = document.getElementById('RInput');
      HSlider     = document.getElementById('HSlider');
      HInput      = document.getElementById('HInput');
      rSlider     = document.getElementById('rSlider');
      rInput      = document.getElementById('rInput');
      zSlider     = document.getElementById('zSlider');
      zInput      = document.getElementById('zInput');
      pOut        = document.getElementById('pOut');
      dhOut       = document.getElementById('dhOut');

      enforceStateBounds();
      applyStateToInputs();

      [omegaSlider,RSlider,HSlider,rSlider,zSlider].forEach(el=>{
        el.addEventListener('input', handleSliderChange);
      });
      [omegaInput,RInput,HInput,rInput,zInput].forEach(el=>{
        el.addEventListener('input', handleNumberChange);
      });

      initIsoInteraction();
      updateAllFromState();

      if(window.MathJax && window.MathJax.typesetPromise){
        MathJax.typesetPromise();
      }
    });
  </script>

  <!-- Feedback context -->
  <script>
    const FEEDBACK = {
      course: 'ME 310',
      sim: 'Eq 2.33 Hydrostatic Pressure in a Liquid Undergoing Rigid-Body Rotation'
    };
    document.addEventListener('DOMContentLoaded', () => {
      const url = new URL('../feedback.html', location.href);
      if (FEEDBACK.course) url.searchParams.set('course', FEEDBACK.course);
      if (FEEDBACK.sim)    url.searchParams.set('sim',    FEEDBACK.sim);
      document.querySelectorAll('a.feedback-link').forEach(a => {
        a.href = url.toString();
        try { localStorage.setItem('fb_ctx', JSON.stringify(FEEDBACK)); } catch {}
      });
    });
  </script>
</body>
</html>
