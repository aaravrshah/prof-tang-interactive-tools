<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bernoulli Head Explorer</title>

<link rel="stylesheet" href="../styles.css" />

<!-- MathJax -->
<script>window.MathJax={chtml:{scale:0.78},options:{renderActions:{addMenu:[]}}}</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- D3 -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
:root{--ink:#0f172a;--muted:#475569;--bg:#f7f8fb;--line:#e5e7eb;--card:#fff;--blue:#2563eb;--red:#ef4444;--water:#93c5fd}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.container{max-width:1100px;margin:0 auto;padding:14px 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0;box-shadow:0 6px 14px rgba(0,0,0,.04)}
.box{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
.schem-wrap{max-width:820px;margin:0 auto}
.controls{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
.ctl{display:flex;flex-direction:column;gap:6px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff}
.ctl>label{font-size:13px;color:var(--muted)}
.ctl input,.ctl select{padding:7px 8px;border:1px solid var(--line);border-radius:8px;width:100%}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.mini label{font-size:12px;color:var(--muted)}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#fff;font-size:12px}
.midgrid{display:grid;gap:14px}
@media(min-width:920px){.midgrid{grid-template-columns:.9fr 1.1fr}}
.botgrid{display:grid;gap:14px}
@media(min-width:920px){.botgrid{grid-template-columns:1fr 1fr}}
.eqwrap{padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fcfcff;overflow-x:auto;margin-bottom:10px}
.eqbig{font-size:clamp(.9rem,.7vw + .58rem,1.02rem);line-height:1.22}
.eqnums{font-size:clamp(.86rem,.6vw + .54rem,.98rem);line-height:1.22}
.note{font-size:13.5px;color:var(--muted)}
svg{width:100%;display:block}
#bars{min-height:260px}
</style>
</head>
<body>
<header class="site-header">
  <div class="container">
    <h1>Bernoulli Head Explorer</h1>
    <p class="subtitle">Energy equation with major/minor losses. Adjust inputs → schematic, equations, and loss breakdown update.</p>
  </div>
</header>

<main class="container">
  <nav class="back-row">
    <a href="../index.html" class="back-home" aria-label="Back to home"><span class="chev">←</span> Home</a>
  </nav>

  <!-- Schematic -->
  <section class="card schem-wrap">
    <div class="box"><div id="schematic"></div></div>
    <div class="note" style="margin-top:8px">
      Assumptions: steady, incompressible, single circular pipe, large reservoirs (V≈0, p≈p<sub>atm</sub>). We solve from \(H=\Delta z+H_p\) for \(V\) and \(Q\); losses are split into <b>major</b> (friction) and <b>minor</b> (entrance, valve, exit).
    </div>
  </section>

  <!-- Inputs + Equations -->
  <section class="midgrid">
    <section class="card">
      <div class="controls" id="inputs">
        <div class="ctl"><label>Elevation difference \( \Delta z = z_1 - z_2 \) (m)</label><input id="dz" type="number" step="0.1" value="8"></div>
        <div class="ctl"><label>Pump head \(H_p\) (m)</label><input id="Hp" type="number" step="0.5" value="0"></div>
        <div class="ctl"><label>Pipe length \(L\) (m)</label><input id="L" type="number" step="1" value="100"></div>
        <div class="ctl"><label>Diameter \(D\) (m)</label><input id="D" type="number" step="0.005" value="0.20"></div>

        <div class="ctl">
          <label>Pipe roughness \( \epsilon \) (absolute, m)</label>
          <select id="rough">
            <option value="0">Plastic/glass — 0</option>
            <option value="1.5e-6">Drawn tubing — 0.0015 mm</option>
            <option value="4.5e-5" selected>Commercial steel — 0.045 mm</option>
            <option value="1.5e-4">Galvanized iron — 0.15 mm</option>
            <option value="2.6e-4">Cast iron — 0.26 mm</option>
            <option value="3.0e-4">Concrete (smooth) — 0.30 mm</option>
            <option value="3.0e-3">Concrete (rough) — 3.0 mm</option>
            <option value="9.0e-4">Riveted steel (tight) — 0.90 mm</option>
          </select>
          <span class="badge">ε: <span id="epsAbs">4.5e-5</span> m • ε/D: <span id="epsRel">2.3e-4</span></span>
        </div>

        <div class="ctl">
          <label>Valve / fitting (sets \(K_v\))</label>
          <select id="valve">
            <option value="0">None — 0.0</option>
            <option value="0.05">Ball valve (open) — 0.05</option>
            <option value="0.15">Gate valve (open) — 0.15</option>
            <option value="0.9">90° elbow — 0.9</option>
            <option value="2.0" selected>Generic valve — 2.0</option>
            <option value="10">Globe valve — 10</option>
          </select>
          <span class="badge">K<sub>v</sub>: <span id="kvShow">2.0</span></span>
        </div>

        <div class="ctl">
          <label>Fluid</label>
          <select id="fluid">
            <option data-rho="998"  data-mu="0.001" selected>Water (20 °C)</option>
            <option data-rho="1.204" data-mu="1.8e-5">Air (20 °C)</option>
            <option data-rho="850"  data-mu="0.10">Light Oil</option>
            <option data-rho="1000" data-mu="0.001">Custom…</option>
          </select>
          <div class="row" style="margin-top:6px">
            <div class="mini"><label>Density ρ (kg/m³)</label><input id="rho" type="number" step="1" value="998" disabled></div>
            <div class="mini"><label>Viscosity μ (Pa·s)</label><input id="mu"  type="number" step="1e-5" value="0.001" disabled></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="eqwrap">
        <div class="eqbig"><b>Step 1 — Available head</b></div>
        <div class="eqbig">\[\Large H \equiv \Delta z + H_p \Rightarrow H = \color{#111827}{\Delta z} + \color{#111827}{H_p}\]</div>
        <div class="eqnums" id="eqH"></div>
      </div>

      <div class="eqwrap">
        <div class="eqbig"><b>Step 2 — Find friction factor \(f\)</b></div>
        <div class="eqbig">
\[ \large Re=\frac{\rho V D}{\mu},\qquad
\epsilon/D = \frac{\epsilon}{D}, \qquad
\text{then (Haaland)}\quad
\frac{1}{\sqrt f} = -1.8\log_{10}\!\left[\left(\frac{\epsilon/D}{3.7}\right)^{1.11}+\frac{6.9}{Re}\right].
\]
        </div>
        <div class="eqnums" id="eqFric"></div>
      </div>

      <div class="eqwrap">
        <div class="eqbig"><b>Step 3 — Loss model (split into major + minor)</b></div>
        <div class="eqbig">
\[ \boxed{\,h_L = h_{L,\text{major}} + h_{L,\text{minor}}\,}
\qquad
h_{L,\text{major}} = f\,\frac{L}{D}\,\frac{V^2}{2g},\quad
h_{L,\text{minor}} = \Sigma K\,\frac{V^2}{2g},\quad
\Sigma K = K_e + K_v + K_{ex}.
\]
        </div>
        <div class="eqnums" id="eqLoss"></div>
      </div>

      <div class="eqwrap" style="margin-bottom:0">
        <div class="eqbig"><b>Step 4 — Solve for \(V\), then \(Q\) from \(H=h_L\)</b></div>
        <div class="eqbig">\[\Large V=\sqrt{\dfrac{2gH}{f\,L/D+\Sigma K}},\qquad Q=\dfrac{\pi D^2}{4}\,V\]</div>
        <div class="eqnums" id="eqSolve"></div>
      </div>
    </section>
  </section>

  <section class="botgrid">
    <div class="card"><div class="box"><div id="bars"></div></div></div>
    <div class="card"><div class="box"><div id="readout" class="note" style="line-height:1.65"></div></div></div>
  </section>
</main>

<script>
const g=9.81, $=id=>document.getElementById(id);
const ids=['dz','Hp','L','D','rho','mu'];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const fmtExp=(x,sig=2)=>x===0?'0':(+x).toExponential(sig);
const fmtRR=x=>x===0?'0':(x>=1e-3?(+x).toFixed(4):(+x).toExponential(2));
const fmt=(x,d=3)=>Number.isFinite(x)?(+x).toFixed(d):'—';
const fHaaland=(Re,rr)=>Re<2000?64/Re:1/Math.pow(-1.8*Math.log10(Math.pow(rr/3.7,1.11)+6.9/Re),2);

function solve(p){
  const H=p.dz+p.Hp;
  if(!(p.D>0&&p.L>0&&p.rho>0&&p.mu>0&&H>0)) return {ok:false,H};
  const K=0.5+p.Kv+1.0;
  let f=0.02,V=0,Re=0;
  for(let i=0;i<40;i++){
    const denom=f*(p.L/p.D)+K;
    V=Math.sqrt(2*g*H/denom);
    Re=p.rho*V*p.D/p.mu;
    const fn=fHaaland(Re,p.epsRel);
    if(!isFinite(fn)) return {ok:false,H};
    if(Math.abs(fn-f)<1e-7){f=fn;break}
    f=0.5*(f+fn);
  }
  const V2g=V*V/(2*g);
  const hf=f*(p.L/p.D)*V2g, hent=.5*V2g, hvalve=p.Kv*V2g, hexit=1.0*V2g;
  const Q=Math.PI*p.D*p.D*V/4;
  return {ok:true,H,V,Q,Re,f,V2g,hf,hent,hvalve,hexit,hL:hf+hent+hvalve+hexit, Ksum:K};
}

/* schematic — more padding + safer label placement */
function drawSchematic(p){
  const host=d3.select('#schematic').html('');
  const W=Math.min(820,host.node().clientWidth||820), H=clamp(Math.round(W*.30),230,340);
  const svg=host.append('svg').attr('viewBox',`0 0 ${W} ${H}`);
  const s=Math.min(1,W/900), pipeW=Math.max(8,12*s), tS=14+5*s, mS=tS-2;

  // More top/bottom margin so titles don’t clip; gives room for labels too
  const m={l:26,r:26,t:22,b:26};

  const tw=Math.max(180,Math.min(.24*W,240)), th=Math.max(.65*H,180);
  const xL=m.l, xR=W-m.r-tw, yT=m.t+6, yB=yT+th, yP=yT+th*.68;

  const scY=Math.max(10,Math.min(28,(th-24)/Math.max(.5,Math.abs(p.dz))));
  const y2=yT+th*.47, y1=clamp(y2-p.dz*scY,yT+8,yB-12);

  const addTxt=(x,y,txt,fs=mS,anc='middle')=>svg.append('text')
        .attr('x',x).attr('y',y).attr('text-anchor',anc).style('font-size',fs+'px').text(txt);
  const ySafe = y => clamp(y, m.t+12, H-m.b-10);

  const defs=svg.append('defs');
  defs.append('marker').attr('id','up').attr('markerWidth',6).attr('markerHeight',6).attr('refX',3).attr('refY',3).attr('orient','auto')
      .append('path').attr('d','M3,0 L6,6 L0,6 Z').attr('fill','#111');
  defs.append('marker').attr('id','dn').attr('markerWidth',6).attr('markerHeight',6).attr('refX',3).attr('refY',3).attr('orient','auto')
      .append('path').attr('d','M3,6 L6,0 L0,0 Z').attr('fill','#111');

  // tanks
  svg.append('rect').attr('x',xL).attr('y',yT).attr('width',tw).attr('height',th).attr('fill','#fff').attr('stroke','#111').attr('rx',9);
  svg.append('rect').attr('x',xR).attr('y',yT).attr('width',tw).attr('height',th).attr('fill','#fff').attr('stroke','#111').attr('rx',9);
  svg.append('rect').attr('x',xL+2).attr('y',y1).attr('width',tw-4).attr('height',yB-y1).attr('fill','var(--water)');
  svg.append('rect').attr('x',xR+2).attr('y',y2).attr('width',tw-4).attr('height',yB-y2).attr('fill','var(--water)');
  svg.append('line').attr('x1',xL+2).attr('x2',xL+tw-2).attr('y1',y1).attr('y2',y1).attr('stroke','#1e3a8a');
  svg.append('line').attr('x1',xR+2).attr('x2',xR+tw-2).attr('y1',y2).attr('y2',y2).attr('stroke','#1e3a8a');

  // pipe + flow arrow
  const xPL=xL+tw+20, xPR=xR-20;
  svg.append('line').attr('x1',xPL).attr('x2',xPR).attr('y1',yP).attr('y2',yP)
     .attr('stroke','#111').attr('stroke-width',pipeW).attr('stroke-linecap','round');
  svg.append('path').attr('d',`M ${xPL+34} ${yP} L ${xPL+64} ${yP}`).attr('stroke','#111').attr('stroke-width',1.8);
  svg.append('polygon').attr('points',`${xPL+64},${yP} ${xPL+54},${yP-6} ${xPL+54},${yP+6}`).attr('fill','#111');

  // valve
  const xV=xPL+.70*(xPR-xPL);
  svg.append('rect').attr('x',xV-9).attr('y',yP-9).attr('width',18).attr('height',18).attr('fill','#fff').attr('stroke','#111').attr('transform',`rotate(45,${xV},${yP})`);
  addTxt(xV, ySafe(yP-22), 'Valve', tS);
  addTxt(xV, ySafe(yP+36), `Kᵥ=${(+$('valve').value).toFixed(2)}`);

  // optional pump
  if(+$('Hp').value>0){
    const xP=xPL+.35*(xPR-xPL);
    svg.append('polygon').attr('points',`${xP-11},${yP+11} ${xP+11},${yP+11} ${xP},${yP-11}`).attr('fill','#fff').attr('stroke','#111');
    addTxt(xP, ySafe(yP-24), '+ Hₚ', tS);
    addTxt(xP, ySafe(yP+36), `${(+$('Hp').value).toFixed(1)} m`);
  }

  // Δz gauge
  const xDz=W-18;
  svg.append('line').attr('x1',xDz).attr('x2',xDz).attr('y1',y2).attr('y2',y1).attr('stroke','#111')
     .attr('marker-start','url(#up)').attr('marker-end','url(#dn)');
  addTxt(xDz+8,(y1+y2)/2,`Δz=${(+$('dz').value).toFixed(1)} m`,tS,'start');

  // label spacing around pipe (adjusted)
  const yLabelL = ySafe(yP - 50);   // higher above pipe
  const yLabelD = ySafe(yP + 50);   // further below pipe
  addTxt((xPL+xPR)/2, yLabelL, `L=${+$('L').value} m`, tS);
  addTxt((xPL+xPR)/2, yLabelD, `D=${+$('D').value} m,  ε=${fmtExp(+$('rough').value)} m (ε/D=${fmtRR((+$('rough').value)/(+$('D').value||1))})`);

  // reservoir titles — placed safely inside top margin
  const yTitle = m.t + 2;
  addTxt(xL+tw/2, yTitle, 'Reservoir 1 (upstream)', tS);
  addTxt(xR+tw/2, yTitle, 'Reservoir 2 (downstream)', tS);
}

function drawBars(s){
  const data=[
    ['Friction', s.hf||0, 'var(--blue)'],
    ['Entrance', s.hent||0, '#64748b'],
    ['Valve', s.hvalve||0, 'var(--red)'],
    ['Exit', s.hexit||0, '#6b7280']
  ];
  const total=data.reduce((a,[,v])=>a+v,0);
  const box=d3.select('#bars').html('');
  let W=box.node()?.getBoundingClientRect().width||box.node()?.clientWidth||420;
  W=Math.max(420, Math.floor(W));
  const H=240, m={l:90,r:18,t:22,b:48};

  const svg=box.append('svg').attr('width',W).attr('height',H).attr('viewBox',`0 0 ${W} ${H}`);
  const x=d3.scaleLinear().domain([0,Math.max(1e-6,d3.max(data,d=>d[1])*1.15,1)]).range([m.l,W-m.r]);
  const y=d3.scaleBand().domain(data.map(d=>d[0])).range([m.t,H-m.b]).padding(.22);

  svg.append('g').attr('transform',`translate(0,${H-m.b})`).call(d3.axisBottom(x));
  svg.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y));
  svg.append('text').attr('x',W/2).attr('y',H-16).attr('text-anchor','middle').text('Head loss (m)');

  svg.selectAll('rect').data(data).enter().append('rect')
     .attr('x',x(0)).attr('y',d=>y(d[0])).attr('width',d=>x(d[1])-x(0)).attr('height',y.bandwidth()).attr('fill',d=>d[2]);
  svg.selectAll('.v').data(data).enter().append('text').attr('class','v')
     .attr('x',d=>x(d[1])+4).attr('y',d=>y(d[0])+y.bandwidth()/2+4).attr('font-size',12)
     .text(d=>`${(d[1]||0).toFixed(2)} m ${total?`(${Math.round(100*d[1]/total)}%)`:''}`);
}

function updateText(p,s){
  const ReInt = Math.round(s.Re);
  const rr = p.epsRel;

  $('eqH').innerHTML =
    `\\[\\large H = \\Delta z + H_p = ${p.dz.toFixed(2)} + ${p.Hp.toFixed(2)} = ${s.H.toFixed(2)}\\;\\text{m}\\]`;

  $('eqFric').innerHTML =
`\\[
\\large Re = \\frac{\\rho V D}{\\mu}
= \\frac{${p.rho}\\cdot ${s.V.toFixed(3)}\\cdot ${p.D}}{${p.mu}}
= ${ReInt},
\\qquad \\epsilon/D = ${fmtRR(rr)}
\\]
\\[
\\large \\text{Haaland: } \\frac{1}{\\sqrt f} =
-1.8\\log_{10}\\!\\left[\\left(\\frac{${fmtRR(rr)}}{3.7}\\right)^{1.11}+\\frac{6.9}{${ReInt}}\\right]
\\;\\Rightarrow\\; f=${s.f.toFixed(4)}
\\]`;

  $('eqLoss').innerHTML =
`\\[
\\large h_{L,\\text{major}} = f\\,\\frac{L}{D}\\,\\frac{V^2}{2g},\\quad
h_{L,\\text{minor}} = \\Sigma K\\,\\frac{V^2}{2g},\\quad
\\Sigma K = 0.5 + ${p.Kv} + 1.0 = ${s.Ksum.toFixed(2)}
\\]`;

  const LoverD = p.L/p.D;
  $('eqSolve').innerHTML =
`\\[
\\large V = \\sqrt{\\frac{2gH}{f\\,L/D + \\Sigma K}}
= \\sqrt{\\frac{2(9.81)(${s.H.toFixed(2)})}{(${s.f.toFixed(4)})\\,(${fmt(LoverD,3)}) + ${s.Ksum.toFixed(2)}}}
= ${s.V.toFixed(3)}\\;\\text{m/s}
\\]
\\[
\\large Q = \\frac{\\pi ${p.D}^2}{4}\\,(${s.V.toFixed(3)}) = ${s.Q.toFixed(4)}\\;\\text{m}^3/\\text{s}
\\]`;

  $('readout').innerHTML = [
    `<b>H</b> = ${s.H.toFixed(2)} m`,
    `<b>Q</b> = ${s.Q.toFixed(4)} m³/s (${(s.Q*1000).toFixed(1)} L/s)`,
    `<b>V</b> = ${s.V.toFixed(3)} m/s`,
    `<b>Re</b> = ${ReInt}  •  <b>f</b> = ${s.f.toFixed(4)}`,
    `<b>Losses</b> (m): friction ${s.hf.toFixed(2)}, entrance ${s.hent.toFixed(2)}, valve ${s.hvalve.toFixed(2)}, exit ${s.hexit.toFixed(2)}`
  ].join('<br/>');

  if(window.MathJax) MathJax.typesetPromise([$('eqH'),$('eqFric'),$('eqLoss'),$('eqSolve')]);
}

function params(){
  const D=+$('D').value, eps=+$('rough').value, epsRel=(D>0?eps/D:0);
  $('epsAbs').textContent = fmtExp(eps);
  $('epsRel').textContent = fmtRR(epsRel);
  return {
    dz:+$('dz').value, Hp:+$('Hp').value, L:+$('L').value, D,
    eps, epsRel, Kv:+$('valve').value, rho:+$('rho').value, mu:+$('mu').value
  };
}

function render(){
  const p=params(); drawSchematic(p);
  const s=solve(p);

  if(!s.ok){
    $('eqH').innerHTML = `\\[\\large H = \\Delta z + H_p = ${(+$('dz').value).toFixed(2)} + ${(+$('Hp').value).toFixed(2)}\\]`;
    $('eqFric').innerHTML = `\\[\\large \\epsilon/D = ${fmtRR(p.epsRel)}\\]`;
    $('eqLoss').innerHTML = '';
    $('eqSolve').innerHTML = '';
    if(window.MathJax) MathJax.typesetPromise([$('eqH'),$('eqFric')]);
    drawBars({hf:0,hent:0,hvalve:0,hexit:0});
    $('readout').innerHTML = `<span class="note">Adjust inputs to compute. Loss bars default to 0.</span>`;
    return;
  }
  updateText(p,s); drawBars(s);
}

document.addEventListener('input', e=>{
  if(ids.includes(e.target.id) || e.target.id==='D') render();
});
document.addEventListener('change', e=>{
  if(e.target.id==='fluid'){
    const o=e.target.selectedOptions[0], custom=e.target.selectedIndex===3;
    $('rho').value=+o.dataset.rho; $('mu').value=+o.dataset.mu;
    $('rho').disabled=$('mu').disabled=!custom; render();
  }else if(e.target.id==='rough'){ render();
  }else if(e.target.id==='valve'){ $('kvShow').textContent=e.target.value; render(); }
});

render(); window.addEventListener('resize', render);
</script>
</body>
</html>
